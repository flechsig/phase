%  File      : /afs/psi.ch/user/f/flechsig/phase/doc/rtrace.tex
%  Date      : <28 Oct 03 11:09:21 flechsig> 
%  Time-stamp: <03 Jan 08 08:41:06 flechsig> 
%  Author    : Uwe Flechsig, flechsig@psi.ch

%  $Source$ 
%  $Date$
%  $Revision$ 
%  $Author$ 

% Datei: USERDISK_3:[FLECHSIG.PHASE.TEXT]RTRACE.TEX
% Datum: 22.JUN.1995
% Stand: 27-FEB-1996
% Autor: FLECHSIG, BESSY Berlin


\chapter{Ray Tracing}   

\section{Source}
\subsection{Hard Edge Source} 
Total hight, width, and divergencys have to be selected. The number of rays is
the product of the 4 point- values.  The space- and divergency- points are
equal spaced.

\subsection{Ring Source} 
The source size is 0. The divergence is equally distributed at an
ellipse. Input: semimajor and semiminor axis of the ellipse. The first
ray starts at 45\grad ($dy$ and $dz$ positive). This source type is
useful to reveal aberrations and for fast optimization with a ray number of 1. Caution:
optimization with a big number of free parameters may fail with this
source- the result can be a wound up circle. 

\subsection{Dipol Source} 
Similar to hard edge source. Hight, width, and vertical divergency are $\sigma$
values, the horizontal divergency hard edge. The number of rays is
the product of the 4 point- values, the individual values are without any
importance.

\subsection{Undulator Source} 

A source of an undulator in a long straigt section of the
BESSY~II storage ring is implemented. The input required is: number of rays,
total length $L$ of the undulator (ca. 4000~mm) and the wavelength $ \lambda$
($\lambda$ only for the source not for the grating $\ldots$). 
Fixed data are  
horizontal width of the electron beam: $\sigma_{hor} = 0.31 mm$, the hight of 
the lectron beam with 3\% coupling $\sigma_{vert} = 0.021 mm$. The diffraction 
is taken into account:
\[ \sigma_d = \frac{\sqrt{L \lambda}}{4\pi} \] 
The resulting vertical source size is: 
$\sigma_{v}=\sqrt{\sigma_{vert}^2+\sigma_d^2}$.

The angular distribution is calculated by the formula:
\[ \sigma_r= \sqrt{\frac{\lambda}{L}} \]

\subsection {Trace of a single ray}
One ray is calculated, input and output are shown in the same window. The
calculation is started with apply.

\section {Optical Element} 
Use the optical element Box. The radius can be calculated automatically, using
the angle theta from the geometry datafile (!this file must be created
previeusly!), and the source and image distances on the left side. For plane
elements one should use the radius 0. 

\subsection {Variable Linespace Gratings}
\[ N = N_0 + 2 N_1 w + 3 N_3 w^2 + 4 N_4 w^3 + 5 N_5 w^4 \]
 
\section {Geometry} 
The geometry of the optical element between two interfaces in the phase space.
$\theta > 0$ means up, $\theta < 0$ means down.


\section {Calculation}
\begin {enumerate} 
\item Create a transformation matrix for each phase space element.
\item Create a transformation matrix for the whole beamline, multiplying the
individual matrixes.
\item Create ray trace a source.
\item Start calculation (ray tracing or single ray).
\item Graphic Output.
\end {enumerate} 

\subsection {Horizontal deviation}
Creation of a transformation matrix for horizontal deviation, using the
transformation matrix for vertical deviation:
\[ M_h= (MAP35\_LH.OMX) M_v (MAP35\_RH.OMX)  \]
$\theta > 0$ means left, $\theta < 0$ means right.
 



\tiny{\it filename: userdisk\_3:[flechsig.phase.text]rtrace.tex}     

